"use strict";

require("6to5/polyfill");
var Promise = require("bluebird");
module.exports = function (R) {
  var _ = R._;
  var should = R.should;
  var requestAnimationFrame = require("raf");

  require("setimmediate");

  function clearAnimationFrame(handle) {
    requestAnimationFrame.cancel(handle);
  }

  var Async = {
    ifMounted: function (fn) {
      var _this = this;
      var _arguments = arguments;
      return function () {
        _.dev(function () {
          return _this._AsyncMixin.should.be.ok;
        });
        if (!_this._AsyncMixinHasUnmounted) {
          return fn.apply(_this, _arguments);
        }
      };
    },

    _deferredImmediate: function (fn) {
      var _this2 = this;
      var _arguments2 = arguments;
      return function () {
        var args = _arguments2;
        var id = _.uniqueId("setImmediate");
        var q = setImmediate(function () {
          delete _this2._AsyncMixinQueuedImmediates[id];
          return fn.apply(_this2, args);
        });
        _this2._AsyncMixinQueuedImmediates[id] = q;
        return id;
      };
    },

    _deferredAnimationFrame: function (fn) {
      var _this3 = this;
      var _arguments3 = arguments;
      return function () {
        var args = _arguments3;
        var id = _.uniqueId("setImmediate");
        var q = requestAnimationFrame(function () {
          delete _this3._AsyncMixinQueuedAnimationFrames[id];
          return fn.apply(_this3, _arguments3);
        });
        _this3._AsyncMixinQueuedAnimationFrames[id] = q;
        return id;
      };
    },

    _deferredTimeout: function (delay) {
      var _this4 = this;
      var _arguments4 = arguments;
      return function (fn) {
        return function () {
          var args = _arguments4;
          var id = _.uniqueId("setTimeout");
          var q = setTimeout(function () {
            delete _this4._AsyncMixinQueuedTimeouts[id];
            return fn.apply(_this4, _arguments4);
          }, delay);
          _this4._AsyncMixinQueuedTimeouts[id] = q;
          return q;
        };
      };
    },

    deferred: function (fn, delay) {
      var ifn = R.Async.ifMounted(fn);
      if (!delay) {
        return R.Async._deferredImmediate(ifn);
      } else {
        return R.Async._deferredTimeout(ifn, delay);
      }
    },

    deferredAnimationFrame: function (fn) {
      var ifn = R.Async.ifMounted(fn);
      return R.Async._deferredAnimationFrame(ifn);
    } };

  _.extend(Async, {
    Mixin: {
      _AsyncMixin: true,
      _AsyncMixinHasUnmounted: false,
      _AsyncMixinQueuedTimeouts: null,
      _AsyncMixinQueuedImmediates: null,
      _AsyncMixinQueuedAnimationFrames: null,

      componentWillMountcomponentWillMount: function () {
        this._AsyncMixinQueuedTimeouts = {};
        this._AsyncMixinQueuedImmediates = {};
        this._AsyncMixinQueuedAnimationFrames = {};
      },

      componentWillUnmount: function () {
        _.each(this._AsyncMixinQueuedTimeouts, clearTimeout);
        _.each(this._AsyncMixinQueuedImmediates, clearImmediate);
        _.each(this._AsyncMixinQueuedAnimationFrames, clearAnimationFrame);
        this._AsyncMixinHasUnmounted = true;
      },

      setStateIfMounted: Async.ifMounted(function () {
        this.setState(state);
      }) } });

  return Async;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImQ6L3dvcmtzcGFjZV9wci9yZWFjdC1yYWlscy9zcmMvUi5Bc3luYy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUN6QixJQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDcEMsTUFBTSxDQUFDLE9BQU8sR0FBRyxVQUFTLENBQUMsRUFBRTtBQUMzQixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2QsTUFBTSxNQUFNLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztBQUN4QixNQUFNLHFCQUFxQixHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQzs7QUFFN0MsU0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDOztBQUV4QixXQUFTLG1CQUFtQixDQUFDLE1BQU0sRUFBRTtBQUNuQyx5QkFBcUIsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7R0FDdEM7O0FBRUQsTUFBTSxLQUFLLEdBQUc7QUFDWixhQUFTLEVBQUEsVUFBQyxFQUFFLEVBQUU7OztBQUNaLGFBQU8sWUFBTTtBQUNYLFNBQUMsQ0FBQyxHQUFHLENBQUM7aUJBQU0sTUFBSyxXQUFXLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUFFO1NBQUEsQ0FBQyxDQUFDO0FBQzNDLFlBQUcsQ0FBQyxNQUFLLHVCQUF1QixFQUFFO0FBQ2hDLGlCQUFPLEVBQUUsQ0FBQyxLQUFLLG1CQUFpQixDQUFDO1NBQ2xDO09BQ0YsQ0FBQztLQUNIOztBQUVELHNCQUFrQixFQUFBLFVBQUMsRUFBRSxFQUFFOzs7QUFDckIsYUFBTyxZQUFNO0FBQ1gsWUFBSSxJQUFJLGNBQVksQ0FBQztBQUNyQixZQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBQ3BDLFlBQUksQ0FBQyxHQUFHLFlBQVksQ0FBQyxZQUFNO0FBQ3pCLGlCQUFPLE9BQUssMkJBQTJCLENBQUMs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Q0FBQztBQUN6RCxTQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQ0FBZ0MsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO0FBQ25FLFlBQUksQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLENBQUM7T0FDckM7O0FBRUQsdUJBQWlCLEVBQUUsS0FBSyxDQUFDLFNBQVMsQ0FBQyxZQUFXO0FBQUUsWUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztPQUFFLENBQUMsRUFDekUsRUFDRixDQUFDLENBQUM7O0FBRUgsU0FBTyxLQUFLLENBQUM7Q0FDZCxDQUFDIiwiZmlsZSI6IlIuQXN5bmMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJyZXF1aXJlKCc2dG81L3BvbHlmaWxsJyk7XG5jb25zdCBQcm9taXNlID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUikge1xyXG4gIGNvbnN0IF8gPSBSLl87XHJcbiAgY29uc3Qgc2hvdWxkID0gUi5zaG91bGQ7XHJcbiAgY29uc3QgcmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gcmVxdWlyZSgncmFmJyk7XHJcblxyXG4gIHJlcXVpcmUoJ3NldGltbWVkaWF0ZScpO1xyXG5cclxuICBmdW5jdGlvbiBjbGVhckFuaW1hdGlvbkZyYW1lKGhhbmRsZSkge1xyXG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lLmNhbmNlbChoYW5kbGUpO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgQXN5bmMgPSB7XHJcbiAgICBpZk1vdW50ZWQoZm4pIHtcclxuICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICBfLmRldigoKSA9PiB0aGlzLl9Bc3luY01peGluLnNob3VsZC5iZS5vayk7XHJcbiAgICAgICAgaWYoIXRoaXMuX0FzeW5jTWl4aW5IYXNVbm1vdW50ZWQpIHtcclxuICAgICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgIH0sXHJcblxyXG4gICAgX2RlZmVycmVkSW1tZWRpYXRlKGZuKSB7XHJcbiAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgbGV0IGFyZ3MgPSBhcmd1bWVudHM7XHJcbiAgICAgICAgbGV0IGlkID0gXy51bmlxdWVJZCgnc2V0SW1tZWRpYXRlJyk7XHJcbiAgICAgICAgbGV0IHEgPSBzZXRJbW1lZGlhdGUoKCkgPT4ge1xyXG4gICAgICAgICAgZGVsZXRlIHRoaXMuX0FzeW5jTWl4aW5RdWV1ZWRJbW1lZGlhdGVzW2lkXTtcclxuICAgICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmdzKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLl9Bc3luY01peGluUXVldWVkSW1tZWRpYXRlc1tpZF0gPSBxO1xyXG4gICAgICAgIHJldHVybiBpZDtcclxuICAgICAgfTtcclxuICAgIH0sXHJcblxyXG4gICAgX2RlZmVycmVkQW5pbWF0aW9uRnJhbWUoZm4pIHtcclxuICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICBsZXQgYXJncyA9IGFyZ3VtZW50cztcclxuICAgICAgICBsZXQgaWQgPSBfLnVuaXF1ZUlkKCdzZXRJbW1lZGlhdGUnKTtcclxuICAgICAgICBsZXQgcSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XHJcbiAgICAgICAgICBkZWxldGUgdGhpcy5fQXN5bmNNaXhpblF1ZXVlZEFuaW1hdGlvbkZyYW1lc1tpZF07XHJcbiAgICAgICAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLl9Bc3luY01peGluUXVldWVkQW5pbWF0aW9uRnJhbWVzW2lkXSA9IHE7XHJcbiAgICAgICAgcmV0dXJuIGlkO1xyXG4gICAgICB9O1xyXG4gICAgfSxcclxuXHJcbiAgICBfZGVmZXJyZWRUaW1lb3V0KGRlbGF5KSB7XHJcbiAgICAgIHJldHVybiAoZm4pID0+ICgpID0+IHtcclxuICAgICAgICBsZXQgYXJncyA9IGFyZ3VtZW50cztcclxuICAgICAgICBsZXQgaWQgPSBfLnVuaXF1ZUlkKCdzZXRUaW1lb3V0Jyk7XHJcbiAgICAgICAgbGV0IHEgPSBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgIGRlbGV0ZSB0aGlzLl9Bc3luY01peGluUXVldWVkVGltZW91dHNbaWRdO1xyXG4gICAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XHJcbiAgICAgICAgfSwgZGVsYXkpO1xyXG4gICAgICAgIHRoaXMuX0FzeW5jTWl4aW5RdWV1ZWRUaW1lb3V0c1tpZF0gPSBxO1xyXG4gICAgICAgIHJldHVybiBxO1xyXG4gICAgICB9O1xyXG4gICAgfSxcclxuXHJcbiAgICBkZWZlcnJlZChmbiwgZGVsYXkpIHtcclxuICAgICAgbGV0IGlmbiA9IFIuQXN5bmMuaWZNb3VudGVkKGZuKTtcclxuICAgICAgaWYoIWRlbGF5KSB7XHJcbiAgICAgICAgcmV0dXJuIFIuQXN5bmMuX2RlZmVycmVkSW1tZWRpYXRlKGlmbik7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIFIuQXN5bmMuX2RlZmVycmVkVGltZW91dChpZm4sIGRlbGF5KTtcclxuICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICBkZWZlcnJlZEFuaW1hdGlvbkZyYW1lKGZuKSB7XHJcbiAgICAgIGxldCBpZm4gPSBSLkFzeW5jLmlmTW91bnRlZChmbik7XHJcbiAgICAgIHJldHVybiBSLkFzeW5jLl9kZWZlcnJlZEFuaW1hdGlvbkZyYW1lKGlmbik7XHJcbiAgICB9LFxyXG4gIH07XHJcblxyXG4gIF8uZXh0ZW5kKEFzeW5jLCB7XHJcbiAgICBNaXhpbjoge1xyXG4gICAgICBfQXN5bmNNaXhpbjogdHJ1ZSxcclxuICAgICAgX0FzeW5jTWl4aW5IYXNVbm1vdW50ZWQ6IGZhbHNlLFxyXG4gICAgICBfQXN5bmNNaXhpblF1ZXVlZFRpbWVvdXRzOiBudWxsLFxyXG4gICAgICBfQXN5bmNNaXhpblF1ZXVlZEltbWVkaWF0ZXM6IG51bGwsXHJcbiAgICAgIF9Bc3luY01peGluUXVldWVkQW5pbWF0aW9uRnJhbWVzOiBudWxsLFxyXG5cclxuICAgICAgY29tcG9uZW50V2lsbE1vdW50Y29tcG9uZW50V2lsbE1vdW50KCkge1xyXG4gICAgICAgIHRoaXMuX0FzeW5jTWl4aW5RdWV1ZWRUaW1lb3V0cyA9IHt9O1xyXG4gICAgICAgIHRoaXMuX0FzeW5jTWl4aW5RdWV1ZWRJbW1lZGlhdGVzID0ge307XHJcbiAgICAgICAgdGhpcy5fQXN5bmNNaXhpblF1ZXVlZEFuaW1hdGlvbkZyYW1lcyA9IHt9O1xyXG4gICAgICB9LFxyXG5cclxuICAgICAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XHJcbiAgICAgICAgXy5lYWNoKHRoaXMuX0FzeW5jTWl4aW5RdWV1ZWRUaW1lb3V0cywgY2xlYXJUaW1lb3V0KTtcclxuICAgICAgICBfLmVhY2godGhpcy5fQXN5bmNNaXhpblF1ZXVlZEltbWVkaWF0ZXMsIGNsZWFySW1tZWRpYXRlKTtcclxuICAgICAgICBfLmVhY2godGhpcy5fQXN5bmNNaXhpblF1ZXVlZEFuaW1hdGlvbkZyYW1lcywgY2xlYXJBbmltYXRpb25GcmFtZSk7XHJcbiAgICAgICAgdGhpcy5fQXN5bmNNaXhpbkhhc1VubW91bnRlZCA9IHRydWU7XHJcbiAgICAgIH0sXHJcblxyXG4gICAgICBzZXRTdGF0ZUlmTW91bnRlZDogQXN5bmMuaWZNb3VudGVkKGZ1bmN0aW9uKCkgeyB0aGlzLnNldFN0YXRlKHN0YXRlKTsgfSksXHJcbiAgICB9LFxyXG4gIH0pO1xyXG5cclxuICByZXR1cm4gQXN5bmM7XHJcbn07XHJcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==